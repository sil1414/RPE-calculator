<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBD RPE Calculator</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding-bottom: 90px;
}

.header {
  padding: 15px;
  background: #fff;
  border-bottom: 1px solid #ccc;
}

h1, h2, h3, h4 {
  margin: 10px 0;
}

select, input {
  padding: 8px;
  font-size: 16px;
}

.view { display: none; }
.view.active { display: block; }

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}

th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #eee;
}

.rep-col { font-weight: bold; }

.arrow {
  display: inline-block;
  width: 14px;
  color: #888;
}

.plate-row {
  background: #fafafa;
  font-size: 14px;
}

.settings-group {
  background: #fff;
  padding: 15px;
  margin: 10px;
  border-radius: 10px;
}

.settings-row {
  display: grid;
  grid-template-columns: 40px 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.settings-header {
  font-weight: bold;
  color: #555;
}

.plate-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-bottom: 15px;
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: #007aff;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
}

.tab-bar {
  position: fixed;
  bottom: 0;
  width: 100%;
  display: flex;
  background: #fff;
  border-top: 1px solid #ccc;
}

.tab-item {
  flex: 1;
  text-align: center;
  padding: 12px;
  color: #666;
  text-decoration: none;
}

.tab-item.active { color: #007aff; }
</style>
</head>

<body>

<!-- Calculator -->
<div id="view-calc" class="view active">
  <div class="header">
    <h1>SBD RPE Calculator</h1>

    Selected RPE:
    <select id="rpe-select" onchange="calculate()"></select>

    <div style="margin-top:8px;">
      Units:
      <label><input type="radio" name="unit" value="kg" checked onchange="calculate()"> kg</label>
      <label><input type="radio" name="unit" value="lb" onchange="calculate()"> lb</label>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="rep-col">Reps</th>
        <th>SQ</th>
        <th>BP</th>
        <th>DL</th>
      </tr>
    </thead>
    <tbody id="dash-body"></tbody>
  </table>
</div>

<!-- Settings -->
<div id="view-settings" class="view">
  <h2 style="padding:10px;">Settings</h2>

  <div class="settings-group">
    <h3>Max & Increment</h3>

    <div class="settings-row settings-header">
      <div></div>
      <div>Max (kg)</div>
      <div>Increment (kg)</div>
    </div>

    <div class="settings-row">
      <label>SQ</label>
      <input id="set-sq" type="number">
      <select id="step-sq">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>

    <div class="settings-row">
      <label>BP</label>
      <input id="set-bp" type="number">
      <select id="step-bp">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>

    <div class="settings-row">
      <label>DL</label>
      <input id="set-dl" type="number">
      <select id="step-dl">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>
  </div>

  <div class="settings-group">
    <h3>Plate Availability</h3>

    <h4>SQ</h4>
    <div class="plate-grid" id="plates-sq"></div>

    <h4>BP</h4>
    <div class="plate-grid" id="plates-bp"></div>

    <h4>DL</h4>
    <div class="plate-grid" id="plates-dl"></div>

    <button class="save-btn" onclick="saveData()">Save Settings</button>
  </div>
</div>

<!-- Tabs -->
<div class="tab-bar">
  <a class="tab-item active" id="tab-calc" onclick="showView('calc')">üìä Calculator</a>
  <a class="tab-item" id="tab-settings" onclick="showView('settings')">‚öôÔ∏è Settings</a>
</div>

<script>
const KG_TO_LB = 2.20462;
const BAR_KG = 20;
const BAR_LB = 45;
const ALL_PLATES = [25,20,15,10,5,2.5,1.25,0.75,0.5];

const baseTable = {
  10:[100,95.5,92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9],
  9.5:[97.8,93.9,90.7,87.8,85,82.4,79.9,77.4,75.1,72.3],
  9:[95.5,92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7],
  8.5:[93.9,90.7,87.8,85,82.4,79.9,77.4,75.1,72.3,69.4],
  8:[92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7,68],
  7.5:[90.7,87.8,85,82.4,79.9,77.4,75.1,72.3,69.4,66.7],
  7:[89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7,68,65.3],
  6.5:[87.8,85,82.4,79.9,77.4,75.1,72.3,69.4,66.7,64],
  6:[86.3,83.7,81.1,78.6,76.2,73.9,70.7,68,65.3,62.6],
  5:[81.1,78.6,76.2,73.9,70.7,68,65.3,62.6,60.1,57.7],
  4:[76.2,73.9,70.7,68,65.3,62.6,60.1,57.7,55.4,53],
  3:[70.7,68,65.3,62.6,60.1,57.7,55.4,53,50.5,48],
  2:[65.3,62.6,60.1,57.7,55.4,53,50.5,48,45,42],
  1:[60.1,57.7,55.4,53,50.5,48,45,42,39,36]
};

let userData = JSON.parse(localStorage.getItem('liftingData_v4')) || {
  max:{sq:150,bp:100,dl:150},
  step:{sq:2.5,bp:0.5,dl:2.5},
  plateConfig:{
    sq:[25,20,15,10,5,2.5,1.25],
    bp:[25,20,10,5,2.5,1.25,0.75,0.5],
    dl:[25,20,15,10,5,2.5]
  }
};

function getUnit() {
  return document.querySelector('input[name="unit"]:checked').value;
}

function displayWeight(kg) {
  return getUnit()==='lb' ? (kg*KG_TO_LB).toFixed(1) : kg.toFixed(1);
}

function calcKg(max, step, p) {
  return Math.round((max*p/100)/step)*step;
}

function calcPlates(totalKg, lift) {
  const unit = getUnit();
  const bar = unit==='lb'?BAR_LB:BAR_KG;
  let total = unit==='lb'?totalKg*KG_TO_LB:totalKg;
  let remain = (total-bar)/2;

  let plates = userData.plateConfig[lift].slice().sort((a,b)=>b-a);
  let out=[];
  plates.forEach(p=>{
    let c=Math.floor(remain/p);
    if(c>0){ out.push(`${p}${unit} √ó${c*2}`); remain-=p*c; }
  });
  return out.join('<br>');
}

function togglePlate(row){
  const detail = row.nextElementSibling;
  const arrow = row.querySelector('.arrow');
  const open = detail.style.display === 'table-row';
  detail.style.display = open ? 'none' : 'table-row';
  arrow.textContent = open ? '‚ñ∂' : '‚ñº';
}

function calculate(){
  const rpe = document.getElementById('rpe-select').value;
  const tbody=document.getElementById('dash-body');
  tbody.innerHTML='';
  baseTable[rpe].forEach((p,i)=>{
    const wSq=calcKg(userData.max.sq,userData.step.sq,p);
    const wBp=calcKg(userData.max.bp,userData.step.bp,p);
    const wDl=calcKg(userData.max.dl,userData.step.dl,p);
    tbody.innerHTML+=`
    <tr onclick="togglePlate(this)">
      <td class="rep-col"><span class="arrow">‚ñ∂</span> ${i+1}</td>
      <td>${displayWeight(wSq)}</td>
      <td>${displayWeight(wBp)}</td>
      <td>${displayWeight(wDl)}</td>
    </tr>
    <tr class="plate-row" style="display:none">
      <td colspan="4">
        SQ:<br>${calcPlates(wSq,'sq')}<br><br>
        BP:<br>${calcPlates(wBp,'bp')}<br><br>
        DL:<br>${calcPlates(wDl,'dl')}
      </td>
    </tr>`;
  });
}

function renderPlateSettings(lift){
  const c=document.getElementById(`plates-${lift}`);
  c.innerHTML='';
  ALL_PLATES.forEach(p=>{
    const chk=userData.plateConfig[lift].includes(p)?'checked':'';
    c.innerHTML+=`<label><input type="checkbox" value="${p}" ${chk}> ${p}kg</label>`;
  });
}

function checkIncrementConflict(lift) {
  const increment = userData.step[lift];
  const plates = userData.plateConfig[lift];
  if (!plates.length) return null;

  const minPlate = Math.min(...plates);
  const minStep = minPlate * 2;

  if (increment % minStep !== 0) {
    return `‚ö†Ô∏è ${lift.toUpperCase()}:\nIncrement ${increment}kg „ÅØ\nÊúÄÂ∞è„Éó„É¨„Éº„Éà ${minPlate}kg ÊßãÊàê„Åß„ÅØÂàª„ÇÅ„Åæ„Åõ„Çì`;
  }
  return null;
}

function saveData(){
  userData.max.sq=parseFloat(document.getElementById('set-sq').value);
  userData.max.bp=parseFloat(document.getElementById('set-bp').value);
  userData.max.dl=parseFloat(document.getElementById('set-dl').value);
  userData.step.sq=parseFloat(document.getElementById('step-sq').value);
  userData.step.bp=parseFloat(document.getElementById('step-bp').value);
  userData.step.dl=parseFloat(document.getElementById('step-dl').value);

  ['sq','bp','dl'].forEach(l=>{
    userData.plateConfig[l]=Array.from(
      document.querySelectorAll(`#plates-${l} input:checked`)
    ).map(b=>parseFloat(b.value));
  });

  localStorage.setItem('liftingData_v4',JSON.stringify(userData));

  const warnings = ['sq','bp','dl']
    .map(checkIncrementConflict)
    .filter(Boolean);

  if (warnings.length) {
    alert(warnings.join('\n\n'));
  }

  calculate();
  showView('calc');
}

function showView(v){
  document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(`view-${v}`).classList.add('active');
  document.getElementById(`tab-${v}`).classList.add('active');
}

function init(){
  const rpeList=[10,9.5,9,8.5,8,7.5,7,6.5,6,5,4,3,2,1];
  document.getElementById('rpe-select').innerHTML =
    rpeList.map(v=>`<option value="${v}" ${v===8?'selected':''}>RPE ${v}</option>`).join('');

  document.getElementById('set-sq').value=userData.max.sq;
  document.getElementById('set-bp').value=userData.max.bp;
  document.getElementById('set-dl').value=userData.max.dl;
  document.getElementById('step-sq').value=userData.step.sq;
  document.getElementById('step-bp').value=userData.step.bp;
  document.getElementById('step-dl').value=userData.step.dl;

  ['sq','bp','dl'].forEach(renderPlateSettings);
  calculate();
}

window.onload=init;
</script>
</body>
</html>
