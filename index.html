<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBD RPE Calculator</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding-bottom: 90px;
}

.header {
  padding: 15px;
  background: #fff;
  border-bottom: 1px solid #ccc;
}

h1, h2, h3, h4 {
  margin: 10px 0;
}

select, input {
  padding: 8px;
  font-size: 16px;
}

.view { display: none; }
.view.active { display: block; }

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}

th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #eee;
  vertical-align: top;
}

.rep-col { font-weight: bold; }

.arrow {
  display: inline-block;
  width: 14px;
  color: #888;
}

.plate-row {
  background: #fafafa;
  font-size: 13px;
}

.warn {
  color: #d32f2f;
  font-weight: bold;
}

.settings-group {
  background: #fff;
  padding: 15px;
  margin: 10px;
  border-radius: 10px;
}

.settings-row {
  display: grid;
  grid-template-columns: 40px 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.settings-header {
  font-weight: bold;
  color: #555;
}

.plate-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-bottom: 15px;
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: #007aff;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
}

.tab-bar {
  position: fixed;
  bottom: 0;
  width: 100%;
  display: flex;
  background: #fff;
  border-top: 1px solid #ccc;
  z-index: 1000;
}

.tab-item {
  flex: 1;
  text-align: center;
  padding: 12px;
  color: #666;
  text-decoration: none;
  user-select: none;
}

.tab-item.active { color: #007aff; }
</style>
</head>

<body>

<!-- Calculator -->
<div id="view-calc" class="view active">
  <div class="header">
    <h1>SBD RPE Calculator</h1>

    Selected RPE:
    <select id="rpe-select" onchange="calculate()"></select>

    <div style="margin-top:8px;">
      Units:
      <label><input type="radio" name="unit" value="kg" checked onchange="calculate()"> kg</label>
      <label><input type="radio" name="unit" value="lb" onchange="calculate()"> lb</label>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="rep-col">Reps</th>
        <th>SQ</th>
        <th>BP</th>
        <th>DL</th>
      </tr>
    </thead>
    <tbody id="dash-body"></tbody>
  </table>
</div>

<!-- Settings -->
<div id="view-settings" class="view">
  <h2 style="padding:10px;">Settings</h2>

  <div class="settings-group">
    <h3>Max & Increment</h3>

    <div class="settings-row settings-header">
      <div></div>
      <div>Max (kg)</div>
      <div>Increment (kg)</div>
    </div>

    <div class="settings-row">
      <label>SQ</label>
      <input id="set-sq" type="number" inputmode="decimal">
      <select id="step-sq">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>

    <div class="settings-row">
      <label>BP</label>
      <input id="set-bp" type="number" inputmode="decimal">
      <select id="step-bp">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>

    <div class="settings-row">
      <label>DL</label>
      <input id="set-dl" type="number" inputmode="decimal">
      <select id="step-dl">
        <option value="0.5">0.5</option>
        <option value="1.0">1.0</option>
        <option value="2.5">2.5</option>
        <option value="5.0">5.0</option>
      </select>
    </div>
  </div>

  <div class="settings-group">
    <h3>Plate Availability</h3>

    <h4>SQ</h4>
    <div class="plate-grid" id="plates-sq"></div>

    <h4>BP</h4>
    <div class="plate-grid" id="plates-bp"></div>

    <h4>DL</h4>
    <div class="plate-grid" id="plates-dl"></div>

    <button class="save-btn" onclick="saveData()">Save Settings</button>
  </div>
</div>

<!-- Tabs -->
<div class="tab-bar">
  <a class="tab-item active" id="tab-calc" onclick="showView('calc')">üìä Calculator</a>
  <a class="tab-item" id="tab-settings" onclick="showView('settings')">‚öôÔ∏è Settings</a>
</div>

<script>
const KG_TO_LB = 2.20462;
const BAR_KG = 20;
const ALL_PLATES = [25,20,15,10,5,2.5,1.25,0.75,0.5,0.25];

const baseTable = {
  10:[100,95.5,92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9],
  9.5:[97.8,93.9,90.7,87.8,85,82.4,79.9,77.4,75.1,72.3],
  9:[95.5,92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7],
  8.5:[93.9,90.7,87.8,85,82.4,79.9,77.4,75.1,72.3,69.4],
  8:[92.2,89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7,68],
  7.5:[90.7,87.8,85,82.4,79.9,77.4,75.1,72.3,69.4,66.7],
  7:[89.2,86.3,83.7,81.1,78.6,76.2,73.9,70.7,68,65.3],
  6.5:[87.8,85,82.4,79.9,77.4,75.1,72.3,69.4,66.7,64],
  6:[86.3,83.7,81.1,78.6,76.2,73.9,70.7,68,65.3,62.6],
  5:[81.1,78.6,76.2,73.9,70.7,68,65.3,62.6,60.1,57.7],
  4:[76.2,73.9,70.7,68,65.3,62.6,60.1,57.7,55.4,53],
  3:[70.7,68,65.3,62.6,60.1,57.7,55.4,53,50.5,48],
  2:[65.3,62.6,60.1,57.7,55.4,53,50.5,48,45,42],
  1:[60.1,57.7,55.4,53,50.5,48,45,42,39,36]
};

let userData = JSON.parse(localStorage.getItem('liftingData_v4')) || {
  max:{sq:150,bp:100,dl:150},
  step:{sq:2.5,bp:0.5,dl:2.5},
  plateConfig:{
    sq:[25,20,15,10,5,2.5,1.25],
    bp:[25,20,10,5,2.5,1.25,0.75,0.5],
    dl:[25,20,15,10,5,2.5]
  }
};

function getUnit() {
  return document.querySelector('input[name="unit"]:checked').value;
}

function displayWeight(kg) {
  return getUnit()==='lb' ? (kg*KG_TO_LB).toFixed(1) : kg.toFixed(2);
}

function calcKg(max, step, p) {
  return Math.round((max*p/100)/step)*step;
}

/* Plate assembly with deficit (kg-based). Also creates "missing plates" message using smallest available plate. */
function calcPlatesAndDeficit(totalKg, lift){
  let remain = (totalKg - BAR_KG) / 2;
  const plates = (userData.plateConfig[lift] || []).slice().sort((a,b)=>b-a);

  const used = [];
  for (const p of plates){
    const c = Math.floor(remain / p);
    if (c > 0){
      used.push(`${p}kg √ó${c*2}`);
      remain -= p * c;
    }
  }

  const ok = Math.abs(remain) < 0.001;

  let missingLines = [];
  if (!ok && plates.length > 0){
    const minPlate = Math.min(...plates);
    const deficit = Math.max(0, remain); // should be >=0 in this greedy approach

    // Minimum extra plates (per side) if ONLY minPlate existed
    const perSideCount = Math.ceil((deficit - 1e-9) / minPlate);
    const totalCount = Math.max(0, perSideCount * 2);

    if (totalCount > 0){
      missingLines.push(`‚ö† Missing plates: ${minPlate}kg √ó${totalCount}`);
    } else {
      missingLines.push(`‚ö† Missing plates to complete this load.`);
    }
    missingLines.push(`Remaining: ${deficit.toFixed(2)}kg per side`);
  }

  return { used, remain, ok, missingLines };
}

function togglePlate(row){
  const detail = row.nextElementSibling;
  const arrow = row.querySelector('.arrow');
  const open = detail.style.display === 'table-row';
  detail.style.display = open ? 'none' : 'table-row';
  arrow.textContent = open ? '‚ñ∂' : '‚ñº';
}

/* ===== Core table render ===== */
function calculate(){
  const rpe = document.getElementById('rpe-select').value;
  const tbody = document.getElementById('dash-body');
  tbody.innerHTML = '';

  baseTable[rpe].forEach((p,i) => {
    const wSq = calcKg(userData.max.sq, userData.step.sq, p);
    const wBp = calcKg(userData.max.bp, userData.step.bp, p);
    const wDl = calcKg(userData.max.dl, userData.step.dl, p);

    const sq = calcPlatesAndDeficit(wSq,'sq');
    const bp = calcPlatesAndDeficit(wBp,'bp');
    const dl = calcPlatesAndDeficit(wDl,'dl');

    tbody.innerHTML += `
      <tr onclick="togglePlate(this)">
        <td class="rep-col"><span class="arrow">‚ñ∂</span> ${i+1}</td>
        <td class="${sq.ok ? '' : 'warn'}">${displayWeight(wSq)}${sq.ok ? '' : ' ‚ùó'}</td>
        <td class="${bp.ok ? '' : 'warn'}">${displayWeight(wBp)}${bp.ok ? '' : ' ‚ùó'}</td>
        <td class="${dl.ok ? '' : 'warn'}">${displayWeight(wDl)}${dl.ok ? '' : ' ‚ùó'}</td>
      </tr>

      <!-- Responsive alignment: SAME table columns (Reps + SQ + BP + DL) -->
      <tr class="plate-row" style="display:none">
        <td></td>
        <td>
          ${sq.used.join('<br>')}
          ${sq.ok ? '' : `<div class="warn" style="margin-top:6px">${sq.missingLines.join('<br>')}</div>`}
        </td>
        <td>
          ${bp.used.join('<br>')}
          ${bp.ok ? '' : `<div class="warn" style="margin-top:6px">${bp.missingLines.join('<br>')}</div>`}
        </td>
        <td>
          ${dl.used.join('<br>')}
          ${dl.ok ? '' : `<div class="warn" style="margin-top:6px">${dl.missingLines.join('<br>')}</div>`}
        </td>
      </tr>
    `;
  });
}

/* ===== Settings UI ===== */
function renderPlateSettings(lift){
  const c = document.getElementById(`plates-${lift}`);
  c.innerHTML = '';
  ALL_PLATES.forEach(p=>{
    const chk = (userData.plateConfig[lift] || []).includes(p) ? 'checked' : '';
    c.innerHTML += `<label><input type="checkbox" value="${p}" ${chk}> ${p}kg</label>`;
  });
}

/* ===== Settings conflict check (SAVE ONLY) ===== */
function toIntKg(x) {
  return Math.round(Number(x) * 1000);
}

function checkIncrementConflict(lift) {
  const increment = Number(userData.step[lift]);
  const plates = (userData.plateConfig[lift] || [])
    .map(Number)
    .filter(n => Number.isFinite(n));

  if (!Number.isFinite(increment) || plates.length === 0) return null;

  const minPlate = Math.min(...plates);
  const minStep = minPlate * 2;

  const incI = toIntKg(increment);
  const stepI = toIntKg(minStep);

  if (stepI === 0) return null;

  if (incI % stepI !== 0) {
    return `‚ö†Ô∏è ${lift.toUpperCase()}:\nIncrement ${increment}kg is incompatible with selected plates.\nSmallest possible step is ${minStep}kg (min plate ${minPlate}kg per side).`;
  }
  return null;
}

function saveData(){
  userData.max.sq = parseFloat(document.getElementById('set-sq').value);
  userData.max.bp = parseFloat(document.getElementById('set-bp').value);
  userData.max.dl = parseFloat(document.getElementById('set-dl').value);

  userData.step.sq = parseFloat(document.getElementById('step-sq').value);
  userData.step.bp = parseFloat(document.getElementById('step-bp').value);
  userData.step.dl = parseFloat(document.getElementById('step-dl').value);

  ['sq','bp','dl'].forEach(l=>{
    userData.plateConfig[l] = Array.from(
      document.querySelectorAll(`#plates-${l} input:checked`)
    ).map(b => parseFloat(b.value));
  });

  localStorage.setItem('liftingData_v4', JSON.stringify(userData));

  const warnings = ['sq','bp','dl']
    .map(checkIncrementConflict)
    .filter(Boolean);

  if (warnings.length) alert(warnings.join('\n\n'));

  calculate();
  showView('calc');
}

/* ===== Tabs ===== */
function showView(v){
  document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
  document.getElementById(`view-${v}`).classList.add('active');
  document.getElementById(`tab-${v}`).classList.add('active');
}

/* ===== Init ===== */
function init(){
  const rpeList = [10,9.5,9,8.5,8,7.5,7,6.5,6,5,4,3,2,1];
  document.getElementById('rpe-select').innerHTML =
    rpeList.map(v => `<option value="${v}" ${v===8 ? 'selected' : ''}>RPE ${v}</option>`).join('');

  document.getElementById('set-sq').value = userData.max.sq;
  document.getElementById('set-bp').value = userData.max.bp;
  document.getElementById('set-dl').value = userData.max.dl;

  document.getElementById('step-sq').value = userData.step.sq;
  document.getElementById('step-bp').value = userData.step.bp;
  document.getElementById('step-dl').value = userData.step.dl;

  ['sq','bp','dl'].forEach(renderPlateSettings);
  calculate();
}

window.onload = init;
</script>
</body>
</html>
